@model ChatRoom
@{
    ViewData["Title"] = Model.Name;
    var messages = ViewBag.Messages as IEnumerable<ChatMessage>;
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isOwner = currentUserId == Model.CreatedById;
    var isAdmin = User.IsInRole("Admin");
}

<div class="chat-room">
    <div class="chat-room-header">
        <h1>@Model.Name</h1>
        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <p>@Model.Description</p>
        }
        <div class="chat-room-actions">
            <a href="/Chat" class="btn btn-secondary">목록으로</a>
            @if (isOwner || isAdmin)
            {
                <form asp-action="Delete" method="post" style="display:inline;"
                      onsubmit="return confirm('채팅방을 삭제하시겠습니까?');">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-danger">삭제</button>
                </form>
            }
        </div>
    </div>

    <div id="chat-messages" class="chat-messages">
        @if (messages != null)
        {
            @foreach (var msg in messages)
            {
                <div class="message @(msg.UserId == currentUserId ? "my-message" : "")">
                    <div class="message-header">
                        <strong>@(msg.User?.DisplayName ?? msg.User?.Email ?? "알 수 없음")</strong>
                        <span>@msg.SentAt.ToString("HH:mm")</span>
                    </div>
                    <div class="message-content">@msg.Content</div>
                </div>
            }
        }
    </div>

    <div class="chat-input">
        <input type="text" id="message-input" placeholder="메시지를 입력하세요..." maxlength="2000" />
        <button id="send-button" class="btn btn-primary">전송</button>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const roomId = @Model.Id;
        const currentUserId = '@currentUserId';

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        // 메시지 수신
        connection.on("ReceiveMessage", function (message) {
            const messagesDiv = document.getElementById("chat-messages");
            const messageDiv = document.createElement("div");
            messageDiv.className = "message" + (message.userId === currentUserId ? " my-message" : "");
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>${escapeHtml(message.userName)}</strong>
                    <span>${message.sentAt.split(' ')[1]}</span>
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // 사용자 입장
        connection.on("UserJoined", function (userName) {
            const messagesDiv = document.getElementById("chat-messages");
            const noticeDiv = document.createElement("div");
            noticeDiv.className = "system-message";
            noticeDiv.textContent = `${userName}님이 입장했습니다.`;
            messagesDiv.appendChild(noticeDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // 사용자 퇴장
        connection.on("UserLeft", function (userName) {
            const messagesDiv = document.getElementById("chat-messages");
            const noticeDiv = document.createElement("div");
            noticeDiv.className = "system-message";
            noticeDiv.textContent = `${userName}님이 퇴장했습니다.`;
            messagesDiv.appendChild(noticeDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // 에러 처리
        connection.on("Error", function (message) {
            alert(message);
        });

        // 연결 시작
        connection.start()
            .then(function () {
                connection.invoke("JoinRoom", roomId);
            })
            .catch(function (err) {
                console.error(err.toString());
            });

        // 메시지 전송
        document.getElementById("send-button").addEventListener("click", sendMessage);
        document.getElementById("message-input").addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                sendMessage();
            }
        });

        function sendMessage() {
            const input = document.getElementById("message-input");
            const message = input.value.trim();
            if (message) {
                connection.invoke("SendMessage", roomId, message)
                    .catch(function (err) {
                        console.error(err.toString());
                    });
                input.value = "";
            }
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        // 페이지 떠날 때 방 퇴장
        window.addEventListener("beforeunload", function () {
            connection.invoke("LeaveRoom", roomId);
        });

        // 스크롤을 맨 아래로
        document.getElementById("chat-messages").scrollTop = document.getElementById("chat-messages").scrollHeight;
    </script>
}
